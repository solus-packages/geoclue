From 5688789384830707488de63dad2f75f88db7a7e5 Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Sat, 19 Mar 2016 16:40:51 +0000
Subject: [PATCH] Support a stateless configuration

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 data/Makefile.am   |  2 +-
 src/Makefile.am    |  1 +
 src/gclue-config.c | 14 +++++++++++---
 3 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/data/Makefile.am b/data/Makefile.am
index 2feacab..68a0124 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -1,4 +1,4 @@
-systemconfdir    = $(sysconfdir)/geoclue
+systemconfdir    = $(datadir)/defaults/geoclue
 systemconf_in_files = geoclue.conf.in
 systemconf_DATA = $(systemconf_in_files:.conf.in=.conf)
 
diff --git a/src/Makefile.am b/src/Makefile.am
index fd5016b..0ed3035 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -62,6 +62,7 @@ AM_CPPFLAGS = $(GEOCLUE_CFLAGS) 		     	  \
 	      -DG_LOG_DOMAIN=\""Geoclue"\"	     	  \
 	      -DABS_TOP_SRCDIR=\""$(abs_top_srcdir)"\" 	  \
 	      -DSYSCONFDIR=\""$(sysconfdir)"\"		  \
+	      -DDATADIR=\""$(datadir)"\"		  \
 	      -I$(srcdir)/agent				  \
 	      -I$(builddir)/agent			  \
 	      -I$(srcdir)/public-api			  \
diff --git a/src/gclue-config.c b/src/gclue-config.c
index 98b1e4c..4650f95 100644
--- a/src/gclue-config.c
+++ b/src/gclue-config.c
@@ -24,7 +24,8 @@
 
 #include "gclue-config.h"
 
-#define CONFIG_FILE_PATH SYSCONFDIR "/geoclue/geoclue.conf"
+#define CONFIG_FILE_PATH            SYSCONFDIR "/geoclue/geoclue.conf"
+#define DEFAULT_CONFIG_FILE_PATH    DATADIR "/defaults/geoclue/geoclue.conf"
 
 /* This class will be responsible for fetching configuration. */
 
@@ -235,6 +236,13 @@ static void
 gclue_config_init (GClueConfig *config)
 {
         GError *error = NULL;
+        const gchar *conf_path = NULL;
+
+        if (g_file_test (CONFIG_FILE_PATH, G_FILE_TEST_EXISTS)) {
+                conf_path = CONFIG_FILE_PATH;
+        } else {
+                conf_path = DEFAULT_CONFIG_FILE_PATH;
+        }
 
         config->priv =
                 G_TYPE_INSTANCE_GET_PRIVATE (config,
@@ -242,12 +250,12 @@ gclue_config_init (GClueConfig *config)
                                             GClueConfigPrivate);
         config->priv->key_file = g_key_file_new ();
         g_key_file_load_from_file (config->priv->key_file,
-                                   CONFIG_FILE_PATH,
+                                   conf_path,
                                    0,
                                    &error);
         if (error != NULL) {
                 g_critical ("Failed to load configuration file '%s': %s",
-                            CONFIG_FILE_PATH, error->message);
+                            conf_path, error->message);
                 g_error_free (error);
 
                 return;
-- 
2.7.3

