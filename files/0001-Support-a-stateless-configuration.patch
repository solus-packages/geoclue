From d76f060d33c10549a3184f197a191ccff578ed6b Mon Sep 17 00:00:00 2001
From: Ikey Doherty <ikey@solus-project.com>
Date: Thu, 28 Jul 2016 00:33:28 +0100
Subject: [PATCH] Support a stateless configuration

Signed-off-by: Ikey Doherty <ikey@solus-project.com>
---
 data/Makefile.am   |  2 +-
 src/Makefile.am    |  1 +
 src/gclue-config.c | 15 ++++++++++++---
 3 files changed, 14 insertions(+), 4 deletions(-)

diff --git a/data/Makefile.am b/data/Makefile.am
index fc837d0..2416c19 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -3,7 +3,7 @@ systemconf_in_files = geoclue.conf.in
 systemdservice_in_files = geoclue.service.in
 
 if BUILD_BACKEND
-systemconfdir    = $(sysconfdir)/geoclue
+systemconfdir    = $(datadir)/defaults/geoclue
 systemconf_DATA = $(systemconf_in_files:.conf.in=.conf)
 
 if BUILD_DEMO_AGENT
diff --git a/src/Makefile.am b/src/Makefile.am
index 20c36c1..64283cd 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -116,6 +116,7 @@ AM_CPPFLAGS = $(GEOCLUE_CFLAGS) 		     	  \
 	      -DG_LOG_DOMAIN=\""Geoclue"\"	     	  \
 	      -DABS_TOP_SRCDIR=\""$(abs_top_srcdir)"\" 	  \
 	      -DSYSCONFDIR=\""$(sysconfdir)"\"		  \
+	      -DDATADIR=\""$(datadir)"\"		  \
 	      -I$(srcdir)/agent				  \
 	      -I$(builddir)/agent			  \
 	      -I$(top_srcdir)/public-api		  \
diff --git a/src/gclue-config.c b/src/gclue-config.c
index 2298a37..a88b8ff 100644
--- a/src/gclue-config.c
+++ b/src/gclue-config.c
@@ -24,7 +24,9 @@
 
 #include "gclue-config.h"
 
-#define CONFIG_FILE_PATH SYSCONFDIR "/geoclue/geoclue.conf"
+#define CONFIG_FILE_PATH            SYSCONFDIR "/geoclue/geoclue.conf"
+#define DEFAULT_CONFIG_FILE_PATH    DATADIR "/defaults/geoclue/geoclue.conf"
+
 
 /* This class will be responsible for fetching configuration. */
 
@@ -256,6 +258,13 @@ static void
 gclue_config_init (GClueConfig *config)
 {
         GError *error = NULL;
+        const gchar *conf_path = NULL;
+
+        if (g_file_test (CONFIG_FILE_PATH, G_FILE_TEST_EXISTS)) {
+                conf_path = CONFIG_FILE_PATH;
+        } else {
+                conf_path = DEFAULT_CONFIG_FILE_PATH;
+        }
 
         config->priv =
                 G_TYPE_INSTANCE_GET_PRIVATE (config,
@@ -263,12 +272,12 @@ gclue_config_init (GClueConfig *config)
                                             GClueConfigPrivate);
         config->priv->key_file = g_key_file_new ();
         g_key_file_load_from_file (config->priv->key_file,
-                                   CONFIG_FILE_PATH,
+                                   conf_path,
                                    0,
                                    &error);
         if (error != NULL) {
                 g_critical ("Failed to load configuration file '%s': %s",
-                            CONFIG_FILE_PATH, error->message);
+                            conf_path, error->message);
                 g_error_free (error);
 
                 return;
-- 
2.9.2

